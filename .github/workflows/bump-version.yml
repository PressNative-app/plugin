# Bump plugin version when changes land on main (e.g. after PR merge).
# Commits the new version to main with [skip ci] so this workflow doesn't run again.
name: Bump version on main

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    # Skip if this commit is already a version bump (avoid loop)
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !startsWith(github.event.head_commit.message, 'Bump version to ') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: current
        run: |
          VER=$(grep -m1 "Version:" pressnative.php | sed -E 's/.*Version:[[:space:]]*([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "Current version: $VER"

      - name: Compute next version (patch bump)
        id: next
        run: |
          CUR="${{ steps.current.outputs.version }}"
          MAJOR=$(echo "$CUR" | cut -d. -f1)
          MINOR=$(echo "$CUR" | cut -d. -f2)
          PATCH=$(echo "$CUR" | cut -d. -f3)
          PATCH=$((PATCH + 1))
          NEW="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "Next version: $NEW"

      - name: Update version in source
        run: |
          NEW="${{ steps.next.outputs.version }}"
          # Plugin header and constant in pressnative.php
          sed -i "s/^ \* Version:     [0-9.]*$/ * Version:     $NEW/" pressnative.php
          sed -i "s/define( 'PRESSNATIVE_VERSION', '[0-9.]*' );/define( 'PRESSNATIVE_VERSION', '$NEW' );/" pressnative.php
          # readme.txt Stable tag
          sed -i "s/^Stable tag: .*/Stable tag: $NEW/" readme.txt
          echo "Updated to $NEW"

      - name: Commit and push version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pressnative.php readme.txt
          git diff --staged --quiet || {
            git commit -m "Bump version to ${{ steps.next.outputs.version }} [skip ci]"
            git push
          }
